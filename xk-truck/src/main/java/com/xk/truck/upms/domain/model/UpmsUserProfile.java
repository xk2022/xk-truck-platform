package com.xk.truck.upms.domain.model;import com.xk.base.domain.model.BaseEntity;import io.swagger.v3.oas.annotations.media.Schema;import jakarta.persistence.*;import jakarta.validation.constraints.Email;import jakarta.validation.constraints.Size;import lombok.*;import org.hibernate.annotations.Comment;import org.hibernate.annotations.JdbcTypeCode;import org.hibernate.annotations.UuidGenerator;import org.hibernate.type.SqlTypes;import java.time.LocalDate;import java.util.Locale;import java.util.UUID;/** * =============================================================== * Entity : UpmsUserProfile * Layer  : Domain Model (UPMS) * Purpose: 使用者「非安全」個人資料（Profile）（延伸資訊） * =============================================================== * <p> * 設計原則（低耦合 / 排雷） * 1) Profile 僅承載「非安全資料」：姓名、聯絡方式、頭像、部門職稱等 * 2) 不放 password / role / permission / security 設定（避免耦合與資料外洩） * 3) 1:1 與 UpmsUser 關聯，但 equals/hashCode/toString 不碰 user（避免 lazy/遞迴） * 4) userUuid 外鍵欄位 + unique constraint，方便 DTO mapping / query * 5) 避免 blob：頭像只存 avatarUrl 或 storageKey * * @author yuan Created on 2025/12/01. * =============================================================== */@Getter@Setter@NoArgsConstructor@AllArgsConstructor@Entity@Table(        name = "upms_user_profile",        indexes = {                @Index(name = "idx_uup_user_uuid", columnList = "user_uuid"),                @Index(name = "idx_uup_email", columnList = "email"),                @Index(name = "idx_uup_phone", columnList = "phone")        },        uniqueConstraints = {                @UniqueConstraint(name = "uk_uup_user_uuid", columnNames = "user_uuid")        })@Schema(description = "UPMS 使用者個人資料（非安全資料）")public class UpmsUserProfile extends BaseEntity {    // ===============================================================    // Primary Key    // ===============================================================    @Id    @GeneratedValue    @UuidGenerator(style = UuidGenerator.Style.TIME)    @JdbcTypeCode(SqlTypes.VARCHAR)    @Column(name = "uuid", length = 36, updatable = false, nullable = false, unique = true)    @Schema(description = "Profile UUID")    private UUID uuid;    // ===============================================================    // FK Column (read-friendly)    // ===============================================================    @JdbcTypeCode(SqlTypes.VARCHAR)    @Column(name = "user_uuid", length = 36, nullable = false)    @Comment("對應 UpmsUser UUID（唯一，一個 user 只能有一份 profile）")    private UUID userUuid;    // ===============================================================    // Relation (LAZY)    // ===============================================================    /**     * ⚠ 排雷：     * - insertable/updatable=false：避免同時維護 userUuid 與 user 關聯造成重複更新     * - Profile 不應 cascade REMOVE 到 User（方向要由 User 管 Profile）     */    @OneToOne(fetch = FetchType.LAZY, optional = false)    @JoinColumn(            name = "user_uuid",            referencedColumnName = "uuid",            insertable = false,            updatable = false,            foreignKey = @ForeignKey(name = "fk_uup_user_uuid")    )    @Comment("對應 upms_user.uuid")    private UpmsUser user;    // ===============================================================    // Profile Fields (非安全)    // ===============================================================    @Size(max = 80)    @Column(name = "name", length = 80)    @Comment("姓名（顯示名稱）")    private String name;    @Size(max = 80)    @Column(name = "nick_name", length = 80)    @Comment("暱稱")    private String nickName;    @Email    @Size(max = 120)    @Column(name = "email", length = 120)    @Comment("Email")    private String email;    @Size(max = 30)    @Column(name = "phone", length = 30)    @Comment("手機/聯絡電話（建議存 E.164 或至少去空白）")    private String phone;    @Size(max = 255)    @Column(name = "avatar_url", length = 255)    @Comment("頭像 URL（或物件儲存 key）")    private String avatarUrl;    @Size(max = 100)    @Column(name = "department", length = 100)    @Comment("部門")    private String department;    @Size(max = 100)    @Column(name = "position", length = 100)    @Comment("職稱")    private String position;    @Size(max = 20)    @Column(name = "gender", length = 20)    @Comment("性別（可選：MALE/FEMALE/OTHER/UNKNOWN；也可改 enum）")    private String gender;    @Column(name = "birthday")    @Comment("生日（可選）")    private LocalDate birthday;    @Size(max = 20)    @Column(name = "locale", length = 20)    @Comment("偏好語系，例如 zh_TW / en_US")    private String locale;    @Size(max = 50)    @Column(name = "timezone", length = 50)    @Comment("偏好時區，例如 Asia/Taipei")    private String timezone;    @Size(max = 255)    @Column(name = "address", length = 255)    @Comment("地址（可選）")    private String address;    @Column(name = "remark", length = 255)    @Comment("備註")    private String remark;    // ===============================================================    // Constructors / Factory    // ===============================================================    public UpmsUserProfile(UUID userUuid) {        this.userUuid = userUuid;    }    public static UpmsUserProfile ofUser(UUID userUuid) {        return new UpmsUserProfile(userUuid);    }    // ===============================================================    // Domain Methods (Normalize)    // ===============================================================    public void normalize() {        if (email != null) email = email.trim().toLowerCase(Locale.ROOT);        if (phone != null) phone = phone.trim().replace(" ", "");        if (name != null) name = name.trim();        if (nickName != null) nickName = nickName.trim();        if (department != null) department = department.trim();        if (position != null) position = position.trim();        if (locale != null) locale = locale.trim();        if (timezone != null) timezone = timezone.trim();        if (address != null) address = address.trim();        if (remark != null) remark = remark.trim();    }    /**     * 由 UpmsUser.setProfile(...) 維護雙向關聯時會呼叫。     * 這裡只做「FK欄位同步」，不要在 Profile 主動去 new User 或修改 User 狀態（避免耦合）。     */    public void setUser(UpmsUser user) {        this.user = user;        this.userUuid = (user != null ? user.getUuid() : null);    }    // ===============================================================    // equals/hashCode (排雷)    // ===============================================================    @Override    public boolean equals(Object o) {        if (this == o) return true;        if (!(o instanceof UpmsUserProfile)) return false;        UpmsUserProfile other = (UpmsUserProfile) o;        return uuid != null && uuid.equals(other.uuid);    }    @Override    public int hashCode() {        return 31;    }    // ===============================================================    // toString（避免 lazy）    // ===============================================================    @Override    public String toString() {        return "UpmsUserProfile{" +                "uuid=" + uuid +                ", userUuid=" + userUuid +                ", name='" + name + '\'' +                ", email='" + email + '\'' +                ", phone='" + phone + '\'' +                '}';    }}